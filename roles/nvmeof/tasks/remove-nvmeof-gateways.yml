---
- name: Get NSID
  shell: |
    podman run -it quay.io/ceph/nvmeof-cli:latest --server-address {{ item.ipaddr }} --server-port {{ item.port }} \
    namespace list --subsystem {{ item.nqn }} 2> /dev/null | sed 1,6d | awk '{print $4}' | head -1
  register: get_nsid
  ignore_errors: true
  with_items: "{{ _nvmeof.gateways }}"
- debug: msg={{ get_nsid }}


- name: Remove Namespace
  shell: |
    podman run -it quay.io/ceph/nvmeof-cli:latest --server-address {{ item.ipaddr }} --server-port {{ item.port }} \
    namespace del --subsystem {{ item.nqn }} --nsid {{ get_nsid.results[0].stdout }}
  register: remove_namespace
  ignore_errors: true
  with_items: "{{ _nvmeof.gateways }}"
- debug: msg={{ remove_namespace }}
  ignore_errors: true
  when: print_debug == true


- name: Remove Listener
  shell: |
    podman run -it quay.io/ceph/nvmeof-cli:latest --server-address {{ item.ipaddr }} --server-port {{ item.port }} \
    listener del --host-name rk9-node01 --subsystem {{ item.nqn }} --traddr {{ item.ipaddr }} --trsvcid 4420 --force
  register: remove_listener
  ignore_errors: true
  with_items: "{{ _nvmeof.gateways }}"
- debug: msg={{ remove_listener }}
  ignore_errors: true
  when: print_debug == true



#- name: Remove bdevs in Target
#  shell: |
#    podman run -it quay.io/ceph/nvmeof-cli:latest --server-address {{ item.ipaddr }} --server-port {{ item.port }} \
#    delete_bdev -b nvmeof-img01
#  register: remove_target_bdevs
#  ignore_errors: true
#  with_items: "{{ _nvmeof.gateways }}"
#- debug: msg={{ remove_target_bdevs}}
#  ignore_errors: true
#  when: print_debug == true


- name: Remove Subsystem
  shell: |
    podman run -it quay.io/ceph/nvmeof-cli:latest --server-address {{ item.ipaddr }} --server-port {{ item.port }} \
    subsystem del --subsystem {{ item.nqn }} --force
  register: remove_subsystem
  ignore_errors: true
  with_items: "{{ _nvmeof.gateways }}"
- debug: msg={{ remove_subsystem }}
  ignore_errors: true
  when: print_debug == true

